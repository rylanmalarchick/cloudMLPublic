
================================================================================
WORK PACKAGE 3: PHYSICAL BASELINE MODEL VALIDATION
================================================================================

SOW: SOW-AGENT-CBH-WP-001 Section 5
Purpose: GO/NO-GO gate for physics-constrained hypothesis
Success Criterion: Mean LOO CV R² > 0
================================================================================

================================================================================
Leave-One-Flight-Out Cross-Validation
================================================================================

================================================================================
Loading Features
================================================================================

WP1 Features: sow_outputs/wp1_geometric/WP1_Features.hdf5
  Keys: ['cloud_edge_x', 'cloud_edge_y', 'derived_geometric_H', 'saa_deg', 'sample_id', 'shadow_angle_deg', 'shadow_detection_confidence', 'shadow_edge_x', 'shadow_edge_y', 'shadow_length_pixels', 'sza_deg', 'true_cbh_km']
  Loaded 3 geometric features
  Features: ['geo_derived_geometric_H', 'geo_shadow_length_pixels', 'geo_shadow_detection_confidence']

WP2 Features: sow_outputs/wp2_atmospheric/WP2_Features.hdf5
  Keys: ['blh_m', 'inversion_height_m', 'lapse_rate_k_per_km', 'latitude', 'lcl_m', 'longitude', 'moisture_gradient', 'profile_confidence', 'sample_id', 'stability_index', 'surface_dewpoint_k', 'surface_pressure_pa', 'surface_temp_k']
  Loaded 5 atmospheric features
  Features: ['atm_blh_m', 'atm_lcl_m', 'atm_inversion_height_m', 'atm_moisture_gradient', 'atm_stability_index']

Loading dataset from config...
Initializing dataset with 5 flight(s).
  - 10Feb25
  - 30Oct24
  - 23Oct24
  - 18Feb25
  - 12Feb25
Using CBH range: [0.10 - 2.00] km
Angles mode: both
Augmentation disabled.
Phase 1: Loading metadata from all flights...
  Loading flight 10Feb25...
    Success: 10868 samples
  Loading flight 30Oct24...
    Success: 12712 samples
  Loading flight 23Oct24...
    Success: 14611 samples
  Loading flight 18Feb25...
    Success: 10343 samples
  Loading flight 12Feb25...
    Success: 13412 samples
Phase 2: Fitting unified scalers...
  Fitting new unified scalers.
  Unified scalers fitted/loaded:
    SZA: mean=47.509, std=4.453
    SAA: mean=183.966, std=52.172
    Y:   mean=0.830, std=0.371
Phase 3: Creating unified dataset...
  Unified dataset: 933 samples across 5 flights.
Fetching unscaled true labels (km)...

--------------------------------------------------------------------------------
Combined Feature Matrix:
  Samples: 933
  Features: 8
  Feature names: ['geo_derived_geometric_H', 'geo_shadow_length_pixels', 'geo_shadow_detection_confidence', 'atm_blh_m', 'atm_lcl_m', 'atm_inversion_height_m', 'atm_moisture_gradient', 'atm_stability_index']
  Flight distribution:
    F0 (30Oct24): 501 samples
    F1 (10Feb25): 163 samples
    F2 (23Oct24): 101 samples
    F3 (12Feb25): 144 samples
    F4 (18Feb25): 24 samples
  Target (CBH) range: [0.120, 1.950] km
================================================================================
  Imputed 1 NaN values in feature 0 (geo_derived_geometric_H) with median=-188.718

--------------------------------------------------------------------------------
Fold 0: Test on 30Oct24 (F0)
--------------------------------------------------------------------------------
  Training samples: 432
  Test samples: 501
  Training GBDT...
  Results:
    R² = -0.7942
    MAE = 0.3468 km
    RMSE = 0.4456 km

--------------------------------------------------------------------------------
Fold 1: Test on 10Feb25 (F1)
--------------------------------------------------------------------------------
  Training samples: 770
  Test samples: 163
  Training GBDT...
  Results:
    R² = -1.9718
    MAE = 0.1922 km
    RMSE = 0.2456 km

--------------------------------------------------------------------------------
Fold 2: Test on 23Oct24 (F2)
--------------------------------------------------------------------------------
  Training samples: 832
  Test samples: 101
  Training GBDT...
  Results:
    R² = -0.2527
    MAE = 0.3938 km
    RMSE = 0.5020 km

--------------------------------------------------------------------------------
Fold 3: Test on 12Feb25 (F3)
--------------------------------------------------------------------------------
  Training samples: 789
  Test samples: 144
  Training GBDT...
  Results:
    R² = -0.2882
    MAE = 0.3794 km
    RMSE = 0.5479 km

--------------------------------------------------------------------------------
Fold 4: Test on 18Feb25 (F4)
--------------------------------------------------------------------------------
  Training samples: 909
  Test samples: 24
  Training GBDT...
  Results:
    R² = -33.0843
    MAE = 0.5678 km
    RMSE = 0.5950 km

Report saved to: sow_outputs/wp3_baseline/WP3_Report.json

================================================================================
WP-3: PHYSICAL BASELINE VALIDATION - EXECUTIVE SUMMARY
================================================================================

Model: Physical_Baseline_GBDT
Features: geometric, atmospheric
Total Samples: 4665
CV Folds: 5

                           AGGREGATE RESULTS (LOO CV)                           
--------------------------------------------------------------------------------
  Mean R²:        -7.2782 ± 12.9180
  Mean MAE:        0.3760 ± 0.1198 km
  Mean RMSE:       0.4672 ± 0.1214 km
--------------------------------------------------------------------------------

                                PER-FOLD RESULTS                                
--------------------------------------------------------------------------------
Fold   Flight     N_test   R²         MAE (km)     RMSE (km)   
--------------------------------------------------------------------------------
0      30Oct24    501      -0.7942    0.3468       0.4456      
1      10Feb25    163      -1.9718    0.1922       0.2456      
2      23Oct24    101      -0.2527    0.3938       0.5020      
3      12Feb25    144      -0.2882    0.3794       0.5479      
4      18Feb25    24       -33.0843   0.5678       0.5950      
--------------------------------------------------------------------------------

                               GO/NO-GO DECISION                                
================================================================================
  Threshold: Mean R² > 0.0
  Achieved:  Mean R² = -7.2782

  ✗ STATUS: FAIL
  ✗ HYPOTHESIS REJECTED
  ✗ Physical features do not generalize across flights
  ✗ Project requires new approach - HALT at WP-3
================================================================================

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
CRITICAL: WP-3 FAILED - HYPOTHESIS REJECTED
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

The physical features baseline does not achieve cross-flight
generalization (R² ≤ 0). This invalidates the core hypothesis.

Project should HALT at WP-3 and not proceed to WP-4.
A new research direction is required.
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
